<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Horse Racing Simulator</title>
        <link rel="stylesheet" href="./style.css">
        <script>
            const racerIds = ['cont1', 'cont2', 'cont3', 'cont4'];
            let activeTimers = [];

            function clearAllTimers() {
                activeTimers.forEach(timer => clearTimeout(timer));
                activeTimers = [];
            }

            function resetRace() {
                clearAllTimers();
                document.getElementById('colorCustom').setAttribute('data-img', 'custom');
                document.getElementById('trainerForm').reset();
                document.getElementById('finishMessage').style.display = "none";
                document.getElementById('error-message').innerHTML = "";

                racerIds.forEach(id => {
                    const el = document.getElementById(id);
                    el.style.transition = "none";
                    el.style.left = "0";
                    el.classList.remove('bobbing');
                });

                // reset images
                document.getElementById('horsePreview').src = "images/horse_mystery.png";
                for (let i = 1; i <= 4; i++) {
                    document.getElementById('runner' + i).src = "images/horse_mystery.png";
                    document.getElementById('name' + i).innerText = "?";
                }
            }

            function changeHorseImage(element) {
                const preview = document.getElementById('horsePreview');
                const trackRunner = document.getElementById('runner1');
                const newSrc = element.getAttribute('data-img');

                if (preview) preview.src = newSrc;
                if (trackRunner) trackRunner.src = newSrc;
            }

            function generateNPCStats() {
                const totalBudget = Math.floor(Math.random() * 6) + 15; // 15-20 total
                let s1 = Math.floor(Math.random() * 8) + 3; // Min speed 3
                let s2 = Math.floor(Math.random() * (totalBudget - s1 - 2)) + 1;
                let s3 = totalBudget - (s1 + s2);

                // Safety check for valid stats
                if (s3 > 10 || s3 < 1) return generateNPCStats();
                return { speed: s1, stamina: s2, fortitude: s3 };
            }

            function randomizeUserStats() {
                const stats = generateNPCStats();
                
                document.getElementById('statSpeed').value = stats.speed;
                document.getElementById('statStamina').value = stats.stamina;
                document.getElementById('statFortitude').value = stats.fortitude;
            }

            function runRaceSimulation() {
                clearAllTimers();
                const errorDiv = document.getElementById('error-message');
                
                // Get values and force to numbers
                const speed = parseInt(document.getElementById('statSpeed').value);
                const stamina = parseInt(document.getElementById('statStamina').value);
                const fortitude = parseInt(document.getElementById('statFortitude').value);
                const raceLength = document.getElementById('strategy').value;

                // Validation logic
                if (isNaN(speed) || isNaN(stamina) || isNaN(fortitude)) {
                    errorDiv.innerHTML = "Error: Please enter numbers for all stats.";
                    return;
                }
                if (speed < 1 || speed > 10 || stamina < 1 || stamina > 10 || fortitude < 1 || fortitude > 10) {
                    errorDiv.innerHTML = "Error: Stats must be between 1 and 10.";
                    return;
                }
                if (speed + stamina + fortitude > 20) {
                    errorDiv.innerHTML = "Error: Total stats exceed 20.";
                    return;
                }
                if (!raceLength) {
                    errorDiv.innerHTML = "Error: Please select a race length.";
                    return;
                }

                errorDiv.innerHTML = "";
                document.getElementById('finishMessage').style.display = "none";

                // Setup Racer Identity
                const nameMap = {
                    "images/horse_black.png": "Twilight Requiem",
                    "images/horse_white.png": "Ghost of Chivalry",
                    "images/horse_red.png": "Red Tide",
                    "images/horse_blue.png": "Ocean Feather",
                    "images/horse_yellow.png": "Morning Glory",
                    "images/horse_green.png": "Clover Fortune",
                    "images/horse_mystery.png": "Unknown Steed"
                };

                const racerName = document.getElementById('racerName').value || "Player 1";
                document.getElementById('name1').innerText = racerName;
                
                const selectedRadio = document.querySelector('input[name="horseColor"]:checked');
                const userImg = selectedRadio ? selectedRadio.getAttribute('data-img') : "horse_mystery.png";
                document.getElementById('runner1').src = userImg;

                // Setup NPCs
                // Setup NPCs
                const allColors = ["images/horse_white.png", "images/horse_black.png", "images/horse_red.png", "images/horse_blue.png", "images/horse_yellow.png", "images/horse_green.png"];
                let npcPool = allColors.filter(c => c !== userImg).sort(() => Math.random() - 0.5);

                for (let i = 0; i < 3; i++) {
                    const runnerImg = npcPool[i];
                    const runnerEl = document.getElementById(`runner${i + 2}`);
                    const nameDisplay = document.getElementById(`name${i + 2}`);
                    
                    // 1. Get the value from the new input fields (npcName1, npcName2, npcName3)
                    const customName = document.getElementById(`npcName${i + 1}`).value;
                    
                    // 2. Get the default name from your nameMap based on the color
                    const defaultName = nameMap[runnerImg];

                    // 3. Set the image
                    runnerEl.src = runnerImg;

                    // 4. Use the custom name if typed; otherwise, use the default name
                    nameDisplay.innerText = customName || defaultName;
                }

                // Race Physics
                let trackDiff = raceLength === "long" ? 10 : (raceLength === "medium" ? 7 : (raceLength === "mile" ? 4 : 2));
                let condPenalty = 0;
                if (document.getElementById('condRain').checked) condPenalty += 0.1;
                if (document.getElementById('condDirt').checked) condPenalty += 0.05;
                if (document.getElementById('condLateNight').checked) condPenalty += 0.05;
                if (document.getElementById('condNervous').checked) condPenalty += 0.15;

                const calcTime = (s) => {
                    let exhaust = 1 + (Math.max(0, trackDiff - s.stamina) * 0.15) + condPenalty;
                    return ((50 / s.speed) * exhaust) * (1 - (s.fortitude * 0.05));
                };

                const p1Time = calcTime({speed, stamina, fortitude});
                const n1Time = calcTime(generateNPCStats());
                const n2Time = calcTime(generateNPCStats());
                const n3Time = calcTime(generateNPCStats());

                const racers = [
                    { id: 'cont1', time: p1Time },
                    { id: 'cont2', time: n1Time },
                    { id: 'cont3', time: n2Time },
                    { id: 'cont4', time: n3Time }
                ];

                // Determine Place
                let rank = 1;
                [n1Time, n2Time, n3Time].forEach(t => { if (p1Time > t) rank++; });
                const resultText = rank === 1 ? "1st Place!" : (rank === 2 ? "2nd Place!" : (rank === 3 ? "3rd Place!" : "4th Place..."));

                // Reset positions instantly before animation
                racers.forEach(r => {
                    const el = document.getElementById(r.id);
                    el.style.transition = "none";
                    el.style.left = "0";
                    el.classList.remove('bobbing');
                });

                // Start Race Animation
                const startRace = setTimeout(() => {
                    racers.forEach(r => {
                        const el = document.getElementById(r.id);
                        el.style.transition = `left ${r.time}s linear`;
                        el.style.left = "calc(100% - 100px)";
                        el.classList.add('bobbing');

                        const individualFinish = setTimeout(() => {
                            el.classList.remove('bobbing');
                            if (r.id === 'cont1') {
                                const msgBox = document.getElementById('finishMessage');
                                msgBox.innerHTML = resultText;
                                msgBox.style.display = "block";
                            }
                        }, r.time * 1000);
                        activeTimers.push(individualFinish);
                    });
                }, 50);
                
                activeTimers.push(startRace);
            }
            
            function triggerCustomUpload() {
                document.getElementById('customHorseUpload').click();
            }

            function handleCustomImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const customSrc = e.target.result;
                        
                        document.getElementById('colorCustom').setAttribute('data-img', customSrc);
 
                        document.getElementById('horsePreview').src = customSrc;
                        document.getElementById('runner1').src = customSrc;
                    };

                    reader.readAsDataURL(input.files[0]);
                }
            }
        
        </script>
    </head>
    
    <body>
        <div class="page-wrapper">
            <aside class="sidebar left-sidebar">
                <img src="images/df1.gif" alt="Decoration">
                <img src="images/df2.gif" alt="Decoration">
                <img src="images/df3.gif" alt="Decoration">
            </aside>
            <main class="main-content">
        <h2>Horse Racing Simulator</h2>
        <div id="error-message" style="color: red; font-weight: bold; margin-bottom: 15px;"></div>
        

        <form id="trainerForm">
            <fieldset>
                <legend>Racer Statistics (must total 20!)</legend>
                <label for="racerName">Racer Name:</label>
                <input type="text" id="racerName" placeholder="e.g. Bob" required><br><br>

                <div class="stats-container">
                    <div class="stat-group">
                        <label for="statSpeed">Speed:</label>
                        <input type="text" id="statSpeed" placeholder="1-10">
                    </div>
                    
                    <div class="stat-group">
                        <label for="statStamina">Stamina:</label>
                        <input type="text" id="statStamina" placeholder="1-10">
                    </div>

                    <div class="stat-group">
                        <label for="statFortitude">Fortitude:</label>
                        <input type="text" id="statFortitude" placeholder="1-10">
                    </div>
                </div>

                <button type="button" onclick="randomizeUserStats()" style="margin-top: 10px; display: block;">Randomize Stats</button>
            </fieldset>

            <fieldset>
                <legend>Horse Color</legend>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div>
                        <input type="radio" id="colorWhite" name="horseColor" value="White" data-img="images/horse_white.png" onchange="changeHorseImage(this)">
                        <label for="colorWhite">White</label><br>

                        <input type="radio" id="colorBlack" name="horseColor" value="Black" data-img="images/horse_black.png" onchange="changeHorseImage(this)">
                        <label for="colorBlack">Black</label><br>

                        <input type="radio" id="colorRed" name="horseColor" value="Red" data-img="images/horse_red.png" onchange="changeHorseImage(this)">
                        <label for="colorRed">Red</label><br>

                        <input type="radio" id="colorBlue" name="horseColor" value="Blue" data-img="images/horse_blue.png" onchange="changeHorseImage(this)">
                        <label for="colorBlue">Blue</label><br>

                        <input type="radio" id="colorYellow" name="horseColor" value="Yellow" data-img="images/horse_yellow.png" onchange="changeHorseImage(this)">
                        <label for="colorYellow">Yellow</label><br>

                        <input type="radio" id="colorGreen" name="horseColor" value="Green" data-img="images/horse_green.png" onchange="changeHorseImage(this)">
                        <label for="colorGreen">Green</label><br>

                        <input type="radio" id="colorCustom" name="horseColor" value="Custom" data-img="custom" onchange="triggerCustomUpload()">
                        <label for="colorCustom">Custom (Upload)</label>
                        <input type="file" id="customHorseUpload" style="display: none;" accept="image/*" onchange="handleCustomImage(this)">

                        
                    </div>

                    <div id="stable-preview" style="text-align: center; border: 2px dashed #003366; padding: 10px; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center;">
                        <img id="horsePreview" src="images/horse_mystery.png" style="width: 200px; height: 200px; object-fit: contain;">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Track Conditions</legend>
                <p>Select all that apply to the current race:</p>
                <input type="checkbox" id="condRain" name="condition" value="Rainy">
                <label for="condRain">Rainy Weather</label><br>
                
                <input type="checkbox" id="condDirt" name="condition" value="Dirt">
                <label for="condDirt">Dirt Track</label><br>

                <input type="checkbox" id="condLateNight" name="condition" value="LateNight">
                <label for="condLateNight">Late Night</label><br>

                <input type="checkbox" id="condNervous" name="condition" value="Nervous">
                <label for="condNervous">Nervous</label><br>
                
            </fieldset>

            <fieldset>
                <legend>Race Length</legend>
                <label for="strategy">Select Strategy:</label>
                <select id="strategy">
                    <option value="">--Select Track Length--</option>
                    <option value="sprint">Sprint</option>
                    <option value="mile">Mile</option>
                    <option value="medium">Medium</option>
                    <option value="long">Long</option>
                </select>
            </fieldset>
            <fieldset>
                <legend>Opponent Names (Optional)</legend>
                <div class="stats-container">
                    <div class="stat-group">
                        <label for="npcName1">Opponent 1:</label>
                        <input type="text" id="npcName1" placeholder="e.g. Steve"><br>
                    </div>
                    <div class="stat-group">
                        <label for="npcName2">Opponent 2:</label>
                        <input type="text" id="npcName2" placeholder="e.g. Horse"><br>
                    </div>
                    <div class="stat-group">
                        <label for="npcName3">Opponent 3:</label>
                        <input type="text" id="npcName3" placeholder="e.g. Pony">
                    </div>
                </div>
            </fieldset>
            <br>
            <button type="button" onclick="runRaceSimulation()">Calculate Race Result</button>
            <button type="button" onclick="resetRace()">Reset Form</button>
        </form>

        <hr>

        <section id="resultsArea">
            <h3>Race Simulation Results</h3>
            <div id="raceTrack" style="position: relative; width: 100%; height: 250px; background: #83b071; border: 4px solid #3e2723; overflow: hidden; margin-bottom: 20px;">
                <div id="finishMessage" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; font-size: 24px; font-weight: bold; background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 10px; display: none;"></div>
                <div style="position: absolute; right: 50px; top: 0; bottom: 0; width: 10px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);"></div>
                
                <div id="cont1" class="horse-container" style="top: 0px;">
                    <div id="name1" class="horse-name">?</div>
                    <img id="runner1" src="images/horse_mystery.png" style="width: 100%;">
                </div>

                <div id="cont2" class="horse-container" style="top: 55px;">
                    <div id="name2" class="horse-name">?</div>
                    <img id="runner2" src="images/horse_mystery.png" style="width: 100%;">
                </div>
                <div id="cont3" class="horse-container" style="top: 110px;">
                    <div id="name3" class="horse-name">?</div>
                    <img id="runner3" src="images/horse_mystery.png" style="width: 100%;">
                </div>
                <div id="cont4" class="horse-container" style="top: 165px;">
                    <div id="name4" class="horse-name">?</div>
                    <img id="runner4" src="images/horse_mystery.png" style="width: 100%;">
                </div>
            </div>
        </section>
        
        <hr>
        <p><small><small>Sidebar gifs by TrinityTheLostFlame!</small></small></p>
        </main>
        <aside class="sidebar right-sidebar">
        <img src="images/df4.gif" alt="Decoration">
        <img src="images/df5.gif" alt="Decoration">
        <img src="images/df6.gif" alt="Decoration">
    </aside>
    </body>
</html>

